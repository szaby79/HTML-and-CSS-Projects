var evalkit_setup={auth_external_tool_id:29,account_url:'https://aolcc-academyoflearning.evaluationkit.com',account_id:3,deployment_id:null,auth_url:'/api/v1/accounts/3/external_tools/sessionless_launch?id=29&url=https%3A%2F%2Faolcc-academyoflearning.evaluationkit.com%2FCanvas%2FLti'};var evalkit_loaded = 0;
var EvaluationKIT = {
  onLoad: function () {
    //console.log('DEBUG: onLoad');

    // exit if in iframe auth
    if (
      ENV.current_user_id === null ||
      window.location.href.indexOf("sessionless_launch") > -1 ||
      window.location.href.indexOf("display=borderless") > -1
    ) {
      //console.log('DEBUG: onLoad - sessionless_launch');
      return;
    }

    // stop user settings call for canvas pages outside our usage of dashboard, course pages, and profile pages
    // TODO convert to read URL instead
    if (
      $("#dashboard").length === 0 &&
      $(".context_external_tool_" + evalkit_setup.auth_external_tool_id)
        .length === 0 &&
      this.getPageCourseId() === 0 &&
      document.location.href.indexOf("/profile") === -1 &&
      document.location.href.indexOf("/grades") === -1
    ) {
      //console.log('DEBUG: onLoad - no dashboard or course');
      return;
    }

    evalkit_loaded += 1;
    if (evalkit_loaded > 3) {
      return;
    } // this should be only 2, one auth re-try, I ramped this up to see if it fixes a bug
    var token = this.getTokenCookie();
    var verify = this.getVerifyCookie();

    //console.log('DEBUG: Verifying token ' + token);
    if (token.length === 0 || verify !== ENV.current_user_id) {
      this.onLti();
    } else {
      this.onUser(token);
    }
  },
  onLti: function () {
    //console.log('DEBUG: onLti');
    var that = this;
    that.startInit(function () {
      var newauth = EvaluationKIT || {};
      newauth.onAuth();
    });
  },
  startInit: function (callback) {
    //console.log('DEBUG: startInit');
    // run callback if success
    // this to pre init on dash before we auth
    var that = this;
    var initCookie = that.getInitCookie();
    if (initCookie !== null && initCookie === false) {
      return;
    }
    if (initCookie !== null && initCookie === true) {
      callback();
      return;
    }
    $.get("/api/v1/users/self/profile", function (data) {
      if (data.login_id.length > 0) {
        var courseid = that.getPageCourseId();
        if (courseid > 0) {
          $.get("/api/v1/courses/" + courseid, function (dataCourse) {
            if (dataCourse.id > 0) {
              that.onAuthInit(
                data.id,
                data.login_id,
                data.integration_id,
                dataCourse.id,
                dataCourse.course_code,
                callback
              );
            } else {
              that.setInitCookie(false);
            }
          });
        } else {
          that.onAuthInit(
            data.id,
            data.login_id,
            data.integration_id,
            0,
            "",
            callback
          );
        }
      } else {
        that.setInitCookie(false);
      }
    });
  },
  onAuthInit: function (
    userid,
    username,
    integration_id,
    courseid,
    coursecode,
    callback
  ) {
    var that = this;
    $.get(
      evalkit_setup.account_url +
        "/Canvas/InitCheck?authId=" +
        evalkit_setup.auth_external_tool_id +
        "&username=" +
        encodeURIComponent(username) +
        "&userid=" +
        userid +
        "&integration_id=" +
        encodeURIComponent(integration_id) +
        "&coursecode=" +
        encodeURIComponent(coursecode) +
        "&courseid=" +
        courseid +
        "&refer=" +
        encodeURIComponent(window.location.pathname + window.location.search) +
        "&nocache=" +
        new Date().getTime(),
      function (dataInit) {
        that.setInitCookie(dataInit.result);
        if (dataInit.result === false) return;
        callback();
      }
    );
  },
  onAuth: function () {
    if (evalkit_setup.deployment_id !== null) {
      this.onAuth3();
      return;
    }
    //console.log('DEBUG: onAuth');
    var xhr = this.createCORSRequest("GET", evalkit_setup.auth_url);
    if (!xhr) {
      return;
    }
    xhr.onload = function () {
      if (xhr.status === 200) {
        var jsondata = $.parseJSON(xhr.responseText.replace("while(1);", "")); // while(1) included for security reasons from canvas
        if ($("#evalkit-lti").length > 0) {
          $("#evalkit-lti").remove();
        }
        $(
          '<iframe src="' +
            jsondata.url +
            '" id="evalkit-lti" style="display:none;"></iframe>'
        ).appendTo($("body"));
      } else {
        var redo = EvaluationKIT || {};
        redo.onLoad();
      }
    };
    xhr.send();
  },
  onAuth3: function () {
    // v3
    //console.log('DEBUG: onAuth3');
    if ($("#evalkit-lti").length > 0) {
      $("#evalkit-lti").remove();
    }
    $(
      '<iframe src="' +
        evalkit_setup.auth_url +
        '" id="evalkit-lti" style="display:none;"></iframe>'
    ).appendTo($("body"));
  },
  onLtiResponse: function (e) {
    //console.log('DEBUG: onLtiResponse');

    if (
      e.origin === null ||
      e.origin.toLowerCase().indexOf(evalkit_setup.account_url) === -1 ||
      e.data === null
    ) {
      //console.log(e.data.length);
      //console.log('DEBUG: e- ' + e.origin + ' - ' + JSON.stringify(e.data));
      return;
    }

    var newobj = EvaluationKIT || {};
    var jsondata = JSON.parse(JSON.stringify(e.data));
    if (jsondata === null) {
      console.log("DEBUG: onLtiResponse - jsondata error");
      return;
    }
    //console.log(jsondata);
    switch (jsondata.subject) {
      case "evalkit.location":
        window.top.location.href = jsondata.url;
        break;
      case "evalkit.ltiresponse":
        var token = jsondata.token;
        //console.log('DEBUG: onLtiResponse - token ' + token);
        if (token.length === 0) token = "-1";
        newobj.setTokenCookie(token);
        newobj.setVerifyCookie(ENV.current_user_id);
        newobj.onLoad();
        break;
    }
  },
  onUser: function (token) {
    //console.log('DEBUG: onUser token' + token);
    if (token === "-1") return;

    // this takes a callback
    this.startInit(function () {
      var newuser = EvaluationKIT || {};
      var courseid = newuser.getPageCourseId();

      //console.log('DEBUG: onUser - token2 = ' + token);
      if (document.getElementById("ek_css") === null) {
        var fileref = document.createElement("link");
        fileref.setAttribute("id", "ek_css");
        fileref.setAttribute("rel", "stylesheet");
        fileref.setAttribute("type", "text/css");
        fileref.setAttribute(
          "href",
          evalkit_setup.account_url + "/css/canvas/style.min.css"
        );
        document.getElementsByTagName("head")[0].appendChild(fileref);
      }
      if (courseid === 0) {
        //console.log('DEBUG: onUser - courseid = 0');
        newuser.getUserSettings(token, courseid, "");
      } else {
        // get real coursecode, because of alias instructors can put on a course and it's shown in UI
        $.ajax({
          url: "/api/v1/courses/" + courseid,
          type: "GET",
          success: function (data) {
            var cc = "";
            try {
              cc = data.course_code;
            } catch (e) {
              var newobjerrinfo = EvaluationKIT || {};
              newobjerrinfo.onError(e);
              /* continue and allow process w/o coursecode */
            }

            var newobjinfo = EvaluationKIT || {};

            newobjinfo.getUserSettings(token, courseid, cc);
          },
          error: function (data) {
            var newobjerr3 = EvaluationKIT || {};
            newobjerr3.onError(data);
            newobjerr3.onLoad();
          },
        });
      }
    });
  },
  getUserSettings: function (token, courseid, coursecode) {
    //jsondatainfo.course_code
    //console.log("DEBUG: getUserSettings");
    var xhr = this.createCORSRequest(
      "GET",
      evalkit_setup.account_url +
        "/canvas/usersettings?token=" +
        encodeURIComponent(token) +
        "&userid=" +
        ENV.current_user_id +
        (courseid > 0
          ? "&courseid=" +
            courseid +
            "&coursecode=" +
            encodeURIComponent(coursecode) +
            "&courseTitle="
          : "") +
        "&refer=" +
        encodeURIComponent(window.location.pathname + window.location.search) +
        "&nocache=" +
        new Date().getTime()
    );
    if (!xhr) {
      return;
    }

    //console.log('DEBUG: getUserSettings - xhr');
    xhr.onload = function () {
      if (xhr.status === 401) {
        var newobj3 = EvaluationKIT || {};
        newobj3.onLti();
      } else {
        try {
          //console.log('DEBUG: getUserSettings - xhr.onload');
          var jsondata = $.parseJSON(xhr.responseText);
          var cj1 = EvaluationKIT || {};
          cj1.onPopup(jsondata);
          cj1.onWidget(jsondata);
          cj1.onLinks(jsondata, courseid);
          // finish up and bing click event to all elements created above.
          $(document).on("click", ".ek-sessionless", function (e) {
            var url = $(this).attr("href");
            e.preventDefault();

            // v3
            if (evalkit_setup.deployment_id !== null) {
              ek_modal.open({
                iframelink: url,
                buttons: null,
                iframeheight: 800,
                cssclass: "evalkit-modal-lg",
                showClose: true,
                type: "notification",
              });
              return;
            }
            var objSL = EvaluationKIT || {};
            var xhrSL = objSL.createCORSRequest("GET", url);
            if (!xhrSL) {
              return;
            }

            // todo refactor repeated code below
            xhrSL.onload = function () {
              if (xhrSL.status === 200) {
                var jsondata = $.parseJSON(
                  xhrSL.responseText.replace("while(1);", "")
                ); // while for security reasons from canvas
                if (
                  typeof jsondata.url !== "undefined" &&
                  jsondata !== null &&
                  jsondata.url.length > 0
                ) {
                  ek_modal.open({
                    iframelink: jsondata.url,
                    buttons: null,
                    iframeheight: 800,
                    cssclass: "evalkit-modal-lg",
                    showClose: true,
                    type: "notification",
                  });
                } else {
                  var redo = EvaluationKIT || {};
                  redo.onLti();
                }
              } else {
                var redo2 = EvaluationKIT || {};
                redo2.onLti();
              }
            };
            xhrSL.send();
          });
        } catch (e) {
          var cj2 = EvaluationKIT || {};
          cj2.onError(e);
        }
        return;
      }
    };
    xhr.onerror = function (e) {
      var er = EvaluationKIT || {};
      if (
        navigator.appVersion.indexOf("MSIE 10") > -1 ||
        navigator.appVersion.indexOf("MSIE 9") > -1
      ) {
        er.onLti();
      } else {
        er.onError(e);
      }
    };
    xhr.send();
  },
  onPopup: function (jsondata) {
    //console.log('DEBUG: onPopup');
    //console.log(jsondata);
    if (jsondata.popup.visible === true) {
      var butts = [];

      /* goto link */
      var goto = document.createElement("a");
      goto.innerHTML = jsondata.popup.gotosurveytext;

      if (
        jsondata.popup.gotosurveyurl.indexOf("sessionless_launch") > -1 ||
        jsondata.popup.gotosurveyurl.indexOf("display=borderless") > -1
      ) {
        goto.setAttribute(
          "class",
          "Button Button--primary ek-widget-btn-primary ek-sessionless"
        );
      } else {
        goto.setAttribute(
          "class",
          "Button Button--primary ek-widget-btn-primary"
        );
      }
      goto.setAttribute("href", jsondata.popup.gotosurveyurl);

      butts[0] = goto;
      //console.log('DEBUG: onPopup - butts');
      /* defer link */
      if (jsondata.popup.remindlater) {
        //console.log('DEBUG: onPopup - remindlater');
        var defer = document.createElement("a");
        defer.innerHTML = jsondata.popup.remindlatertext;
        defer.setAttribute("href", "#");
        defer.setAttribute("class", "Button ek-widget-btn-default");

        if (jsondata.popup.incrementDefer === true) {
          defer.onclick = function (e) {
            e.preventDefault();
            ek_modal.close();
            var olater = EvaluationKIT || {};
            $.get(
              evalkit_setup.account_url +
                "/canvas/defer?token=" +
                encodeURIComponent(olater.getTokenCookie()) +
                "&projectId=" +
                jsondata.popup.projectId +
                "&courseId=" +
                jsondata.popup.courseId +
                "&nocache=" +
                new Date().getTime()
            );
          };
        } else {
          defer.onclick = function (e) {
            e.preventDefault();
            ek_modal.close();
          };
        }
        butts[1] = defer;
      }
      //console.log('DEBUG: onPopup - ek_modal');
      ek_modal.open({
        title: jsondata.popup.header,
        body: jsondata.popup.body,
        buttons: butts,
        showClose: false,
        type: jsondata.popup.blockPage === true ? "blocker" : "notification",
      });
    }
  },
  onWidget: function (jsondata) {
    //console.log('DEBUG: onWidget');
    //setTimeout for timing issues with canvas populating #right-side
    setTimeout(function () {
      $(jsondata.widget).appendTo("#right-side");
    }, 2000);
  },
  onLinks: function (jsondata, courseid) {
    //console.log('DEBUG: onLinks');
    // remove auth link
    //$("a.context_external_tool_" + evalkit_setup.auth_external_tool_id).remove();

    this.setLink(jsondata.userlink, courseid);
    this.setLink(jsondata.studentlink, courseid);
    this.setLink(jsondata.instructorlink, courseid);
    this.setLink(jsondata.talink, courseid);
    this.setLink(jsondata.adminlink, courseid);
  },
  createCORSRequest: function (method, url) {
    try {
      var xhr = new XMLHttpRequest();
      if ("withCredentials" in xhr) {
        /* XHR for Chrome/Firefox/Opera/Safari.*/
        xhr.open(method, url, true);
      } else if (typeof XDomainRequest !== "undefined") {
        /* XDomainRequest for IE.*/
        xhr = new XDomainRequest();
        xhr.open(method, url);
      } else {
        /* CORS not supported.*/
        xhr = null;
      }
      return xhr;
    } catch (e) {
      this.onError(e);
    }
  },
  getPageCourseId: function () {
    if (typeof $("body").attr("class") !== "undefined") {
      return $("body")
        .attr("class")
        .match(/\bcontext-course_(.[0-9]*)/)
        ? parseInt(
            $("body")
              .attr("class")
              .match(/\bcontext-course_(.[0-9]*)/)[1]
          )
        : 0;
    }
    return 0;
  },
  getPageUserId: function () {
    if (
      $("body")
        .attr("class")
        .match(/\bcontext-user_(.[0-9]*)/)
    ) {
      return $("body")
        .attr("class")
        .match(/\bcontext-user_(.[0-9]*)/)[1];
    }
    return "";
  },
  getTokenCookie: function () {
    return (
      evalkit_readCookie(
        "evalkit_token_" + evalkit_setup.auth_external_tool_id
      ) || ""
    );
  },
  setTokenCookie: function (token) {
    evalkit_createCookie(
      "evalkit_token_" + evalkit_setup.auth_external_tool_id,
      token
    );
  },
  getVerifyCookie: function () {
    return (
      evalkit_readCookie(
        "evalkit_verify_" + evalkit_setup.auth_external_tool_id
      ) || ""
    );
  },
  setVerifyCookie: function (val) {
    evalkit_createCookie(
      "evalkit_verify_" + evalkit_setup.auth_external_tool_id,
      val
    );
  },
  // this returns empty, true or false
  getInitCookie: function () {
    // check same user?
    var v = evalkit_readCookie(
      "evalkit_init_verfiy_" + evalkit_setup.auth_external_tool_id
    ); // this is UserId
    if (v === null || v === "") v = -1;
    if (v !== -1 && v !== ENV.current_user_id) {
      evalkit_createCookie(
        "evalkit_init_verfiy_" + evalkit_setup.auth_external_tool_id,
        ENV.current_user_id
      );
      evalkit_createCookie(
        "evalkit_init_" + evalkit_setup.auth_external_tool_id,
        ""
      );
      return null;
    }
    var j = evalkit_readCookie(
      "evalkit_init_" + evalkit_setup.auth_external_tool_id
    );
    if (j === null || j === "") return null;

    var section = this.getSection();
    if (section === null) return false; // THIS SHOULD NEVER HIT!!!... from the if statement way top.

    var o = JSON.parse(j);
    for (var i = 0; i < o.length; i++) {
      if (o[i].section === section) return o[i].val; // bool value
    }
    return null;
  },
  setInitCookie: function (val) {
    var j = evalkit_readCookie(
      "evalkit_init_" + evalkit_setup.auth_external_tool_id
    );
    //console.log("DEBUG: setInitCookie - j = " + j);
    if (j === null || j === "") j = "";

    var section = this.getSection();
    if (section === null) return; // THIS SHOULD NEVER HIT!!!... from the if statement way top.

    var o = j.length === 0 ? [] : JSON.parse(j);

    var found = false;
    for (var i = 0; i < o.length; i++) {
      if (o[i].section === section) {
        found = true;
        o[i].val = val;
      }
    }
    if (found === false) {
      o.push({
        section: section,
        val: val,
      });
    }
    evalkit_createCookie(
      "evalkit_init_verfiy_" + evalkit_setup.auth_external_tool_id,
      ENV.current_user_id
    );
    evalkit_createCookie(
      "evalkit_init_" + evalkit_setup.auth_external_tool_id,
      JSON.stringify(o)
    );
  },
  getSection: function () {
    var section = null;
    if ($("#dashboard").length > 0) {
      section = "dashboard";
    } else if (document.location.href.indexOf("/profile") > -1) {
      section = "profile";
    } else if (this.getPageCourseId() > 0) {
      section = this.getPageCourseId();
    } else if (document.location.href.indexOf("/grades") > -1) {
      section = "dashboard";
    }
    return section;
  },
  setLink: function (jsonlink) {
    if (jsonlink === null || jsonlink.url === null) {
      return;
    }
    var canvasclientlink = $(
      "a.context_external_tool_" + jsonlink.exttoolid
    ); /*canvas tool link*/
    if (jsonlink.visible) {
      if (
        canvasclientlink.length === 0 ||
        canvasclientlink.hasClass("evalkit-ltilink")
      ) {
        $(
          "<li class='section evalkitlink'><a style='display:block !important;' class='evalkit-ltilink ltilinkcontext_external_tool_" +
            jsonlink.exttoolid +
            "' href='" +
            jsonlink.url +
            "'>" +
            jsonlink.title +
            "</a></li>"
        ).appendTo("#section-tabs");
        canvasclientlink = $("a.context_external_tool_" + jsonlink.exttoolid);
      } else {
        canvasclientlink.attr("style", "display: block !important;");
        canvasclientlink.attr("href", jsonlink.url);
        if (jsonlink.title !== canvasclientlink.html())
          canvasclientlink.html(jsonlink.title);
      }

      if (jsonlink.badge !== null) {
        $(
          '<b class="nav-badge evalkit-badge">' + jsonlink.badge + "</b>"
        ).prependTo(canvasclientlink);
      }
      canvasclientlink.parent().show();
    } else {
      if (!canvasclientlink.hasClass("evalkit-ltilink"))
        canvasclientlink.parent().hide();
      return;
    }
    canvasclientlink.addClass("evalkit-ltilink");
  },
  onError: function (e) {
    //console.log('EvaluationKIT Canvas User Integration Error: ' + e);
    //console.log('EvaluationKIT Canvas User Integration Error Stack: ' + e.stack);
  },
};
$(document).ready(function () {
  //if (evalkit_issafari) {
  //    $('.tool_content_wrapper').css('-webkit-overflow-scrolling', 'touch').css('overflow-y', 'scroll');
  //}
  var ekstart = EvaluationKIT || {};
  if (!window.addEventListener) {
    window.attachEvent("onmessage", ekstart.onLtiResponse); /* IE8*/
  } else {
    window.addEventListener("message", ekstart.onLtiResponse, false);
  }

  ekstart.onLoad();
});
var ek_modal = (function () {
  //console.log('DEBUG: ek_modal');
  var method = {},
    $ekoverlay,
    $modal,
    $header,
    $body,
    $footer,
    $close;
  var previouslyFocusedElement = null;
  var focusableElements = [];
  var firstFocusableElement = null;
  var lastFocusableElement = null;

  //console.log('DEBUG: ek_modal - $ekoverlay');
  $ekoverlay = document.createElement("div");
  $ekoverlay.id = "ek-overlay";
  $ekoverlay.style.display = "none";

  $modal = document.createElement("div");
  $modal.id = "ek-modal";
  $modal.style.display = "none";
  $modal.setAttribute("role", "dialog");
  $modal.setAttribute("tabindex", "0");
  $modal.setAttribute("aria-live", "assertive");
  $modal.setAttribute("aria-labelledby", "ek-modal-header");
  $modal.setAttribute("aria-modal", "true");

  var content = document.createElement("div");
  content.setAttribute("class", "ek-modal-content");

  $header = document.createElement("h2");
  $header.setAttribute("class", "ek-modal-header");
  $header.id = "ek-modal-header";

  $close = document.createElement("a");
  $close.setAttribute("id", "ek-modal-close");
  $close.setAttribute("href", "#");
  $close.setAttribute("tabindex", "0");
  $close.setAttribute("role", "button");
  $close.setAttribute("aria-label", "Close dialog");

  $body = document.createElement("div");
  $body.setAttribute("class", "ek-modal-body");
  $body.setAttribute("id", "ek-modal-body");

  $footer = document.createElement("div");
  $footer.setAttribute("class", "ek-modal-footer");

  content.appendChild($header);
  content.appendChild($close);
  content.appendChild($body);
  content.appendChild($footer);

  $modal.appendChild(content);

  // Focus management functions
  function getFocusableElements() {
    var focusable = $modal.querySelectorAll(
      'a[href], button, textarea, input[type="text"], input[type="radio"], input[type="checkbox"], select, [tabindex]:not([tabindex="-1"])'
    );
    var visibleFocusable = [];

    // Filter out elements that are not visible
    for (var i = 0; i < focusable.length; i++) {
      var element = focusable[i];
      var style = window.getComputedStyle(element);
      if (
        style.display !== "none" &&
        style.visibility !== "hidden" &&
        element.offsetParent !== null
      ) {
        visibleFocusable.push(element);
      }
    }

    return visibleFocusable;
  }

  function trapFocus(e) {
    if (e.keyCode === 9) {
      // Tab key
      if (e.shiftKey) {
        if (document.activeElement === firstFocusableElement) {
          e.preventDefault();
          lastFocusableElement.focus();
        }
      } else {
        if (document.activeElement === lastFocusableElement) {
          e.preventDefault();
          firstFocusableElement.focus();
        }
      }
    }
  }

  function handleEscape(e) {
    if (e.keyCode === 27) {
      // Escape key
      e.preventDefault();
      method.close();
    }
  }

  function handleTabKey(e) {
    // Only handle tab key if modal is visible
    if ($modal.style.display === "none") {
      return;
    }

    trapFocus(e);
  }

  method.open = function (settings) {
    if (settings === null) {
      //console.log('ek_modalopen settings === null');
      return;
    }
    if (typeof settings.cssclass !== "undefined" && settings.cssclass !== null)
      $modal.setAttribute("class", settings.cssclass);
    // else $modal.setAttribute('class', '');

    $body.innerHTML = "";
    if (
      typeof settings.iframelink !== "undefined" &&
      settings.iframelink !== null &&
      settings.iframelink.length > 0
    ) {
      $body.innerHTML =
        '<iframe id="ek-modal-iframe-loading"></iframe><iframe src=' +
        settings.iframelink +
        ' id="ek-modal-iframe" style=\'display:none;\' onload="evalkit_modal_iframe();"></frame>';
      window.removeEventListener("resize", evalkit_modal_iframe_resize);
      window.addEventListener("resize", evalkit_modal_iframe_resize);
      evalkit_modal_iframe_resize();
      // Ensure close button is visible for iframe modals
      var closeButton = document.getElementById("ek-modal-close");
      if (closeButton) {
        closeButton.style.display = "";
      }

      document
        .getElementById("ek-modal-iframe-loading")
        .contentWindow.document.write(
          '<html><head></head><body style="text-align:center;"><img src="' +
            evalkit_setup.account_url +
            '/Media/Images/loadingd2l.gif" style="padding-top:10%;" /></body></html>'
        );

      // For iframe modals, focus the close button initially
      setTimeout(function () {
        if (closeButton) {
          closeButton.focus();
        }
      }, 100);
    } else {
      $body.innerHTML = settings.body;
      //////////// document.getElementById('ek-modal-close').style.display = "none";
    }
    if (typeof settings.title !== "undefined" && settings.title !== null) {
      $header.innerHTML = settings.title;
      $header.style.display = "";
      //console.log('DEBUG: ek_modal - display');
    } else {
      $header.style.display = "none";
      //console.log('DEBUG: ek_modal - $header.style.display');
    }
    //console.log('DEBUG: ek_modal - open3' + settings.type);
    $ekoverlay.setAttribute("class", "ek-overlay-" + settings.type);

    if (settings.type === "blocker") {
      var bgcolor = window
        .getComputedStyle(document.getElementById("header"), null)
        .getPropertyValue("background-color");
      if (bgcolor.length === 0) bgcolor = "rgb(57, 75, 88)";
      $ekoverlay.style.background = bgcolor;
    } else {
      $ekoverlay.style.background = "";
    }
    $modal.setAttribute("oncontextmenu", "return false");
    $ekoverlay.setAttribute("oncontextmenu", "return false");

    $ekoverlay.style.display = "";

    //console.log('DEBUG: ek_modal - open4');

    /* open popup */
    $modal.style.display = "";
    $modal.setAttribute("data-type", settings.type);

    // Store the currently focused element
    previouslyFocusedElement = document.activeElement;

    // Get focusable elements and set up focus trapping
    focusableElements = getFocusableElements();
    if (focusableElements.length > 0) {
      firstFocusableElement = focusableElements[0];
      lastFocusableElement = focusableElements[focusableElements.length - 1];
    }

    // Add event listeners for focus trapping
    $modal.addEventListener("keydown", handleTabKey);
    document.addEventListener("keydown", handleEscape);

    // Set initial focus immediately
    setTimeout(function () {
      // Re-get focusable elements after content is loaded
      focusableElements = getFocusableElements();
      if (focusableElements.length > 0) {
        firstFocusableElement = focusableElements[0];
        lastFocusableElement = focusableElements[focusableElements.length - 1];

        // Set focus to the first focusable element
        firstFocusableElement.focus();
      } else {
        // Fallback: focus the modal itself
        $modal.focus();
        // Update focusable elements to include the modal
        firstFocusableElement = $modal;
        lastFocusableElement = $modal;
      }
    }, 0);

    window.scrollTo(0, 0);
    $("body").addClass("ek-modal-open");
    setTimeout(function () {
      $("body").removeClass("ek-modal-open");
    }, 2000);
    //console.log('DEBUG: ek_modal - open5');

    if (
      typeof settings.buttons !== "undefined" &&
      settings.buttons !== null &&
      settings.buttons.length > 0
    ) {
      $footer.innerHTML = "";
      for (var i = 0; i < settings.buttons.length; i++) {
        $footer.appendChild(settings.buttons[i]);
      }
      $footer.style.display = "";
    } else {
      $footer.innerHTML = "";
      $footer.style.display = "none";
    }

    // Set initial focus after content is loaded
    setTimeout(function () {
      // Re-get focusable elements after content is loaded
      focusableElements = getFocusableElements();
      if (focusableElements.length > 0) {
        firstFocusableElement = focusableElements[0];
        lastFocusableElement = focusableElements[focusableElements.length - 1];

        // Set focus to the first focusable element
        firstFocusableElement.focus();
      } else {
        // Fallback: focus the modal itself
        $modal.focus();
        // Update focusable elements to include the modal
        firstFocusableElement = $modal;
        lastFocusableElement = $modal;
      }

      // Announce modal to screen readers
      var announcement = document.createElement("div");
      announcement.setAttribute("aria-live", "polite");
      announcement.setAttribute("aria-atomic", "true");
      announcement.style.position = "absolute";
      announcement.style.left = "-10000px";
      announcement.style.width = "1px";
      announcement.style.height = "1px";
      announcement.style.overflow = "hidden";
      announcement.textContent = "Dialog opened";
      document.body.appendChild(announcement);

      // Remove announcement after it's been read
      setTimeout(function () {
        if (announcement.parentNode) {
          announcement.parentNode.removeChild(announcement);
        }
      }, 1000);
    }, 50);
    // Set close button visibility - show by default unless explicitly hidden
    if (settings.showClose === false) {
      $close.style.display = "none";
    } else {
      $close.style.display = "";
    }
    if (settings.refreshOnClose === true) {
      $close.onclick = function (event) {
        event.preventDefault();
        method.close();
        document.location.href = document.location.href;
      };
    } else {
      $close.onclick = function (event) {
        event.preventDefault();
        method.close();
      };
    }
    //console.log('DEBUG: ek_modal - open end');
  };
  method.close = function () {
    // Remove event listeners
    $modal.removeEventListener("keydown", handleTabKey);
    document.removeEventListener("keydown", handleEscape);

    // Restore focus to the previously focused element
    if (
      previouslyFocusedElement &&
      typeof previouslyFocusedElement.focus === "function"
    ) {
      previouslyFocusedElement.focus();
    }

    // Reset focus management variables
    previouslyFocusedElement = null;
    focusableElements = [];
    firstFocusableElement = null;
    lastFocusableElement = null;

    // Announce modal closure to screen readers
    var announcement = document.createElement("div");
    announcement.setAttribute("aria-live", "polite");
    announcement.setAttribute("aria-atomic", "true");
    announcement.style.position = "absolute";
    announcement.style.left = "-10000px";
    announcement.style.width = "1px";
    announcement.style.height = "1px";
    announcement.style.overflow = "hidden";
    announcement.textContent = "Dialog closed";
    document.body.appendChild(announcement);

    // Remove announcement after it's been read
    setTimeout(function () {
      if (announcement.parentNode) {
        announcement.parentNode.removeChild(announcement);
      }
    }, 1000);

    $("body").removeClass("ek-modal-open"); // prob not needed
    /*document.body.style.overflow = '';*/
    $ekoverlay.style.display = "none";
    $modal.style.display = "none";
    $body.innerHTML = "";
    /*   $(window).unbind('resize.modal');*/
  };
  document.body.appendChild($ekoverlay);
  document.body.appendChild($modal);

  //console.log('DEBUG: ek_modal - return method');
  return method;
})();
function evalkit_modal_iframe(event) {
  //console.log('DEBUG: evalkit_modal_iframe');
  var iframe = document.getElementById("ek-modal-iframe");
  var iframel = document.getElementById("ek-modal-iframe-loading");
  iframe.style.display = "";
  iframel.style.display = "none";

  // Re-setup focus management after iframe loads
  setTimeout(function () {
    var modal = document.getElementById("ek-modal");
    if (modal) {
      // Re-get focusable elements after iframe content loads
      var focusable = modal.querySelectorAll(
        'a[href], button, textarea, input[type="text"], input[type="radio"], input[type="checkbox"], select, [tabindex]:not([tabindex="-1"])'
      );

      // Filter out hidden elements
      var visibleFocusable = [];
      for (var i = 0; i < focusable.length; i++) {
        var element = focusable[i];
        var style = window.getComputedStyle(element);
        if (
          style.display !== "none" &&
          style.visibility !== "hidden" &&
          element.offsetParent !== null
        ) {
          visibleFocusable.push(element);
        }
      }

      if (visibleFocusable.length > 0) {
        visibleFocusable[0].focus();
      } else {
        // Fallback to close button
        var closeButton = document.getElementById("ek-modal-close");
        if (closeButton) {
          closeButton.focus();
        }
      }
    }
  }, 200);
}
function evalkit_modal_iframe_resize() {
  var iframe = document.getElementById("ek-modal-iframe");
  if (iframe !== null) iframe.setAttribute("height", window.innerHeight - 180);
  var iframel = document.getElementById("ek-modal-iframe-loading");
  if (iframel !== null)
    iframel.setAttribute("height", window.innerHeight - 180);
}
function evalkit_createCookie(name, value) {
  var d = new Date(); // now local
  var utcNowTotalMS = Date.UTC(
    d.getFullYear(),
    d.getMonth(),
    d.getDate(),
    d.getHours(),
    d.getMinutes(),
    d.getSeconds(),
    d.getMilliseconds()
  );
  //  //console.log("Set Cookie " + name + ", value is : " + value);

  sessionStorage.setItem(name + "_E", utcNowTotalMS); // local time, total ms since 1970
  sessionStorage.setItem(name, value);
}
function evalkit_readCookie(name) {
  // will only return if less than 30 mins old
  var totalMSCreated = sessionStorage.getItem(name + "_E");

  // if expires not exists then remove the value if exists or not, and return
  if (totalMSCreated === null) {
    //console.log("Read Cookie " + name + " is null");
    sessionStorage.removeItem(name);
    return null;
  }

  // is expires older than 30 mins?
  var d = new Date(); // local now
  var totalMSNow = Date.UTC(
    d.getFullYear(),
    d.getMonth(),
    d.getDate(),
    d.getHours(),
    d.getMinutes(),
    d.getSeconds(),
    d.getMilliseconds()
  );
  var diffMS = totalMSNow - totalMSCreated;

  //console.log("Read Cookie diffMS " + (diffMS / 1000));

  //console.log("Read Cookie " + name + " seconds old: " + (diffMS / 1000));
  if (diffMS > 1000 * 60 * 30) {
    // 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins// 30 mins
    //console.log("Read Cookie " + name + " is expired");
    sessionStorage.removeItem(name + "_E");
    sessionStorage.removeItem(name);
    return null;
  }

  //console.log("Read Cookie " + name + " value is : " + sessionStorage.getItem(name));
  return sessionStorage.getItem(name);
}
